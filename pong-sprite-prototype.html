<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transcendental PONG</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
</head>
<body>
    <script>
        function getRandomNum(min, max) {
            return Math.random() * (max - min) + min;
        }

        const   config = {
            type: Phaser.AUTO, //WEBGL if available. Canvas otherwise.
            width: 800,
            height: 600,
            physics: {
                default: 'arcade',
                arcade: {
                    debug: false
                }
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };
        var game = new Phaser.Game(config);
        var waitingPlayer;
        var initText;
        var ball;
        var playerA;
        var aquaman;
        var aquaman_shape;
        var aquaman_action = false;
        var aquaman_shape_action = false;
        var scoreA;
        var scoreB;
        var scoreText;
        const   scoreTextContent = " player - computer ";
        var cursors;

        //1st Load game resources (images, textures, audio, etc.)
        function preload() {
            this.load.image('aquaman', './aquaman-action-no-background-gray.png');
        }

        //2nd Game objects creation
        function create() {
            //Init screen setup
            initText = this.add.text(400, 250, "Press enter to start",
                                        { fontSize: '20px', fill: '#fff' });
            initText.setDepth(1);
            //Sets the origin coordinates of the object to its center
            initText.setOrigin(0.5);
            waitingPlayer = true;

            //Aquaman creation
            aquaman = this.add.sprite(720, 0, 'aquaman');
            aquaman.scale = 0.5;
            aquaman.setOrigin(0, 1);

            //Aquaman shape
            //x final_position: 430
            //y final_position: 290
            aquaman_shape = this.add.rectangle(720, 0, 40, 400, 0xffffff);
            aquaman_shape.setOrigin(0.5, 1);
            aquaman_shape.angle = 45;
            aquaman_shape.visible = false;
            this.physics.add.existing(aquaman_shape, false);
            aquaman_shape.body.setImmovable(true);

            //Ball creation
            ball = this.add.ellipse(400, 300, 10, 10, 0xffffff);
            //Ball physics setup
            this.physics.add.existing(ball, false);
            ball.body.setVelocity(0);
            ball.setOrigin(0.5);
            ball.body.setBounce(1.2);
            ball.body.setCollideWorldBounds(true);
            //To capture ball collision events with world bounds
            ball.body.onWorldBounds = true;

            //PlayerA creation
            playerA = this.add.rectangle(50, 25, 10, 50, 0xffffff);
            //PlayerA physics setup
            this.physics.add.existing(playerA, false);
            playerA.body.setCollideWorldBounds(true);
            playerA.body.setImmovable(true);

            //Collisions setup
            this.physics.add.collider(ball, playerA, function () {
                if (ball.y >= playerA.y) //Hit the ball with lower half of paddle
                {
                    if (!ball.body.velocity.y) //Hit the ball with static paddle
                    {
                        ball.body.setVelocity(
                            getRandomNum(80, 200), //X velocity
                            getRandomNum(0, 200) //Y velocity
                        );
                    }
                    else //Hit the ball while moving paddle
                    {
                        ball.body.setVelocity(
                            getRandomNum(180, 300), //X velocity
                            getRandomNum(0, 300) //Y velocity
                        );
                    }
                }
                else //Hit the ball with upper half of paddle
                {
                    if (!ball.body.velocity.y) //Hit the ball with static paddle
                    {
                        ball.body.setVelocity(
                            getRandomNum(80, 200), //X velocity
                            getRandomNum(-200, 0) //Y velocity
                        );
                    }
                    else //Hit the ball while moving paddle
                    {
                        ball.body.setVelocity(
                            getRandomNum(180, 300), //X velocity
                            getRandomNum(-300, 0) //Y velocity
                        );
                    }
                }
            });

            //Aquaman ball collision setup
            this.physics.add.overlap(ball, aquaman_shape, () => {
                if (ball.x <= aquaman_shape.x + 50
                    && ball.x >= aquaman_shape.x - 50
                    && ball.y >= aquaman_shape.y - 50)
                {
                    ball.body.setVelocity(-700, 700);
                }
            });

            //Callback for collision events with world bounds
            this.physics.world.on('worldbounds', function (body, up, down, left, right) {
                if (left) //ball collides with left world bound
                { //playerB earns a point
                    scoreB += 1;
                    scoreText.setText(scoreA + scoreTextContent + scoreB);
                    waitingPlayer = true;
                    initText.setVisible(true);
                    ball.body.stop();
                    ball.body.reset(400, 300);
                }
            })

            //Score creation
            scoreA = 0;
            scoreB = 0;
            scoreText = this.add.text(400, 20, scoreA + scoreTextContent + scoreB,
                                        { fontSize: '20px', fill: '#fff' });
            scoreText.setOrigin(0.5);

            //Activate keyboard input
            enter = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ENTER);
            cursors = this.input.keyboard.createCursorKeys(); //up, left, down, right
        }

        //3rd Main loop
        function update() {
            //To stop player paddle if not pressing any movement keys
            playerA.body.setVelocity(0);

            if (cursors.up.isDown) //Move playerA's paddle up
            {
                playerA.body.setVelocityY(-400);
            }
            else if (cursors.down.isDown) //Move playerA's paddle down
            {
                playerA.body.setVelocityY(400);
            }
            else if (enter.isDown && waitingPlayer == true)
            {//To start playing for a new point
                waitingPlayer = false;
                initText.setVisible(false);
                //Initial ball movement towards the player who serves
                ball.body.setVelocity(
                    getRandomNum(-300, -150),
                    getRandomNum(-300, 300)
                );
            }
            else if (cursors.left.isDown)
            {
                if (aquaman_action != true && aquaman_shape_action != true)
                {
                    aquaman_action = true;
                    aquaman_shape_action = true;
                }
            }
            if (aquaman_action === true)
            {
                if (aquaman.x > 430)
                {
                    if (aquaman.x - 35 <= 430)
                        aquaman.x = 430;
                    else
                        aquaman.x -= 35;
                }
                if (aquaman.y < 290)
                {
                    if (aquaman.y + 35 >= 290)
                        aquaman.y = 290;
                    else
                        aquaman.y += 35;
                }
                if (aquaman.x === 430 && aquaman.alpha > 0)
                    aquaman.alpha -= 0.02
                else if (aquaman.alpha <= 0)
                {
                    aquaman.x = 720;
                    aquaman.y = 0;
                    aquaman.alpha = 1;
                    aquaman_action = false;
                }
            }
            if (aquaman_shape_action === true)
            {
                if (aquaman_shape.body.velocity.x === 0)
                {
                    aquaman_shape.body.setVelocity(-1500, 1500);
                }
                if (aquaman_shape.x <= 430)
                {
                    aquaman_shape.body.stop();
                    aquaman_shape.body.reset(720, 0);
                    aquaman_shape_action = false;
                }
            }
        }

    </script>
</body>
</html>
